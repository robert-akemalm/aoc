package aoc2024;

import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import aoc2024.Util.Direction;
import aoc2024.Util.Pos;

public class Day6 {
    private static void a(Input input) {
        System.out.println(visitedBeforeExit(input.obstacles, input.guard, input.direction, input.yLength, input.xLength).size());
    }

    private static void b(Input input) {
        Set<Pos> possible = visitedBeforeExit(input.obstacles, input.guard, input.direction, input.yLength, input.xLength);
        possible.remove(input.guard);
        int count = 0;
        for (Pos newObstacle : possible) {
            if (!input.obstacles().contains(newObstacle)) {
                Set<Pos> obstacles = new HashSet<>(input.obstacles);
                obstacles.add(newObstacle);
                if (visitedBeforeExit(obstacles, input.guard, input.direction, input.yLength, input.xLength).isEmpty()) {
                    count++;
                }
            }
        }
        System.out.println(count);
    }

    private static Set<Pos> visitedBeforeExit(Set<Pos> obstacles, Pos guard, Direction direction, int yLength, int xLength) {
        Map<Pos, Set<Direction>> visited = new HashMap<>();
        while (0 <= guard.x() && guard.x() < xLength && 0 <= guard.y() && guard.y() < yLength) {
            if (!visited.computeIfAbsent(guard, k -> new HashSet<>()).add(direction)) {
                return Set.of();
            }
            Pos next = guard.next(direction);
            if (obstacles.contains(next)) {
                direction = switch (direction) {
                    case UP -> Direction.RIGHT;
                    case DOWN -> Direction.LEFT;
                    case LEFT -> Direction.UP;
                    case RIGHT -> Direction.DOWN;
                };
            } else {
                guard = next;
            }
        }
        return visited.keySet();
    }

    record Input(Set<Pos> obstacles, Pos guard, Direction direction, int yLength, int xLength) {
        static Input parse(String input) {
            Set<Pos> obstacles = new HashSet<>();
            Pos guard = null;
            Direction direction = null;
            List<String> lines = input.lines().toList();
            for (int y = 0; y < lines.size(); y++) {
                String line = lines.get(y);
                for (int x = 0; x < line.length(); x++) {
                    char c = line.charAt(x);
                    if (c == '#') {
                        obstacles.add(new Pos(x, y));
                    } else if (c != '.') {
                        guard = new Pos(x, y);
                        if (c == '^') {
                            direction = Direction.UP;
                        } else if (c == 'v') {
                            direction = Direction.DOWN;
                        } else if (c == '<') {
                            direction = Direction.LEFT;
                        } else if (c == '>') {
                            direction = Direction.RIGHT;
                        }
                    }
                }
            }
            return new Input(obstacles, guard, direction, lines.size(), lines.get(0).length());
        }
    }

    private static final String TEST_INPUT = "....#.....\n"
                                             + ".........#\n"
                                             + "..........\n"
                                             + "..#.......\n"
                                             + ".......#..\n"
                                             + "..........\n"
                                             + ".#..^.....\n"
                                             + "........#.\n"
                                             + "#.........\n"
                                             + "......#...";

    private static final String INPUT =
            "......#........#.............#.##..........................................#.......#...#........#......................#..........\n"
            + ".......................#...#................................#..#.........................................#.....#.....#............\n"
            + ".......................................#.................#..................#....#........................................#.......\n"
            + ".............#...................#.#...............................#....#....#.#.......................................#..#.......\n"
            + "...............................#........##.#..............................#..............................#..#...#..#..............\n"
            + "........................#......................................................................................#..#...............\n"
            + "............................#..........#.......#...................#.....#..................#.....................#..##...........\n"
            + "......................................................##........................#..............#........#..............#..#...#...\n"
            + "............................#.............................................##..........................................#...........\n"
            + "..........#............#....................................#...........#......................................................#..\n"
            + "....#......#.........................................#.......#...............................#..#.##..................#........#..\n"
            + "........................#.#..........##.#..........#......#.......#............................................................#..\n"
            + "..........................................................................................#.#..........................#..........\n"
            + ".............................#............#.......................#................#....................................#.........\n"
            + "...................................#.........................#.............#......#...#................................#.....#....\n"
            + "..........#..................#..#.....................#...#...#.........................................#................#........\n"
            + "....#....#...........#...#..........................................#.............#..#......#................#.....#..............\n"
            + "....................................................................................#......#....##..##....#.......................\n"
            + "...........................#......................#.........##................#............#.......................#...#..........\n"
            + "...........................#....................#............................................#........#.........................#.\n"
            + "..#......#.......#.#...........................#......#....#.#...#.............................#............#..............#......\n"
            + ".......#................#...................................#.........................#..................................#........\n"
            + "..................................................................#...........................................................#...\n"
            + "......................#....#........................................................................................#.............\n"
            + "...#..................#.......#......................................................................#.#....................#.....\n"
            + "................#....................................#.........#..#.........................#...............#.......#.............\n"
            + ".......................................#.................#..................................#...#...........#.....................\n"
            + "....#.....###..................#........#...#..............#............#...............................................#.........\n"
            + "...................#.......................................................#...................................#..................\n"
            + "....#......................................#...##.....#........#......#......#..........................................#.........\n"
            + "......................#............#...............#................#...............................#.............................\n"
            + "......................#..............................................#...........#............#.................................#.\n"
            + "#.#..............................#..#......#.............#.......#......................#...........#........#..........#.........\n"
            + "....#....#.......................................#.......................................................#........................\n"
            + ".......#............................#...........................#.........................#...............#.......................\n"
            + ".....................................#........#.....#........#.......................#...............#..........................#.\n"
            + "....#.......................................#........#......................................................#.................#...\n"
            + "............#..............#...#.......#..#.................................................................................##...#\n"
            + "...#..................#...................#....#............................................................................#.....\n"
            + ".....#....................#...............#.............................................#.....#...............................#...\n"
            + "..............................#.......................#.................#.......................................................#.\n"
            + ".........#....................#..............................................................................#.................#..\n"
            + "......#..................#.........................#.......#.....#...........#....#...................................#......#....\n"
            + ".........#...#......................#......#.................#.........................................#...................#......\n"
            + "....#....#.................................#..#..#........#............................................#.......#..................\n"
            + "....................#...........................#...#............#...........................#....................................\n"
            + "................#................#....#.......................................#....#..........#.#.#..........#....................\n"
            + "....#............................#...................................#.....................................................#.#....\n"
            + "....................................#............#......................#......................##.....................#.......#...\n"
            + ".........................#...................................#.....#................................................#.............\n"
            + "...........#.#..#............................................................................#.#..................................\n"
            + "....#......#.#..................................................#..#....#...#..#...................................#..............\n"
            + "#.........................#.#.................................................................#.#.............................#...\n"
            + "..................#...#........#.......................................................#....#..............................#...#..\n"
            + ".........#..........#.............................................................................................#...............\n"
            + "....................................................................#.......................#..#............#............#........\n"
            + ".................#.................#.............................................#..................................#.............\n"
            + ".#...................................................................................................#................#...........\n"
            + "...#....#.#.#.........#............#..............................................................................................\n"
            + "..................#...#......................................#...#.............#....#....#................#.......................\n"
            + ".....#................................##....................................................................#.....................\n"
            + "............#..................#......#....................#.....#.#.........................##............#............#.......#.\n"
            + "............................#..#.................#.............................................#..................................\n"
            + "............#...............#..........................................................#........#.................................\n"
            + ".......#.......#.......................................##..............##.........................................................\n"
            + "....................#.........#.....#..............#....#.......................................................#.................\n"
            + "...#............................................................#.............................................#...#............#..\n"
            + "....#..............................#...............................#..........................................#...................\n"
            + "............................................................................................................#....................#\n"
            + "..#.............................................................................................................#............#....\n"
            + "..........#...............#.........................................................#...........#.................................\n"
            + "...............#.....................#....................................#....................#.....#...#.....................#..\n"
            + ".#......#.........................................................................................#..#............................\n"
            + "......#..............#........#........#........#.........................................................#.......................\n"
            + "............................#...........#..#.............................................................................#........\n"
            + "..................#..............#.......................................#.........#...............#.....................#.#......\n"
            + "...........................................#.##...................................................................................\n"
            + ".......................#.............................................................................................#............\n"
            + "..........#................................#......#..............................#.................#........#......#.#.........#..\n"
            + "#.......#........................#.....#..........##......#................#......................................#..#..#......#..\n"
            + "........................##........................#....................#......................................#.................#.\n"
            + "..........................#.#........................................................................................#............\n"
            + "..........#.........#.....#......#............#..#................................................##.................#............\n"
            + "........#.....#............##...........................................#..#...............................................#.....#\n"
            + "..............#.......#......................#.....#.......................#.........#........#.................#...#....#........\n"
            + "..............#.................................#.................................................##..............................\n"
            + "................................#........#...........#........................................................#...................\n"
            + "..#.#..................#....#......#..............................#.....#....#.#.............#...............................#....\n"
            + ".....................................................................#......#.........#.......#.........................#....#..#.\n"
            + ".#..........................#.....#...........................................##..^.#..........................#....#....#....#...\n"
            + "...........................#..#................................................................#...#........#.........#...........\n"
            + "......#.................#..............#................#.........#........................#..#........#......#...................\n"
            + ".....#..................#..........#............................................................................#.#...........#...\n"
            + "..........#.........#.................................#......#....#...............#.....................#...#.....................\n"
            + "...........#.......#...........#..#...............#...#..............#...........................................#................\n"
            + "..............................................................#...................................................................\n"
            + "................#..............#.....................#.......#.....................................................#..............\n"
            + "#................#.......#.#..............................#..........................#.............................#..........#...\n"
            + ".#...#.........##..........#......................#....#.........#....................#...............................#.....#.....\n"
            + "....#......#.................#....................................#...............................................................\n"
            + "......#..........#...............................................................#....#...............#.....#.##..................\n"
            + "............................................................#..................#..#...................#.....#.....................\n"
            + "......................#.......#...#....#....................................#.............................#............#..........\n"
            + ".#.............#.....................#...............#.......#...............##.....#..................##...#.....................\n"
            + "........#........................................................###.#..........................................#.................\n"
            + "...##.#................................................................................................#..........................\n"
            + ".............##................#.............#....................#....#......................#........................#.....#....\n"
            + "..#.......#............................................#...............................................#..........................\n"
            + ".................#....#.......................................................#............#..#........................#.......#.#\n"
            + "...#..#......................#............#........#...........................................................................#..\n"
            + "....................................#.......................#.....................................#.....#..#......................\n"
            + ".#...............#......#...........#.....#........##....#.......#.....#...................................................#......\n"
            + "...................#...#............................#..##........#...........................#...........#........................\n"
            + "....................#.#.....................................................................................#......#..............\n"
            + "....#...........#....#...#...#.....................#............................................#..............#..................\n"
            + "......#.#......#................#......................................#...............#..........................................\n"
            + ".......#.#................#..............#.....................#.#......#..................#......................................\n"
            + ".....#................................#..............#.......#......##........#................................#..........#.......\n"
            + ".....................................#......#.........#...#.....#..........#..........................#...........................\n"
            + "......#.......#............................................................#..#....................#...............#.........#....\n"
            + ".........................#...........#.............#......#..#..............................................................#.....\n"
            + ".........#.......##.....#....................................#.....#..............#......#.......#..................##.........#..\n"
            + ".........................#...................#...#.....#...........................................#.................#..#.........\n"
            + "...........#..........#.......................................................................................................#..#\n"
            + ".....#................................................#...........................................................#....#..........\n"
            + "..............#.................................#.............#.........................................................#.........\n"
            + "............#.........................................................#.....#...............................................#.....\n"
            + "..................................................#.................#.............................#....#...#.........#.......#....\n"
            + "........#................#................................................................#................#....................#.\n"
            + "..................##............................###.........#.......#................#........#......#............#...............";

    public static void main(String[] args) {
        Util.time(() -> a(Input.parse(TEST_INPUT)));
        Util.time(() -> a(Input.parse(INPUT)));
        Util.time(() -> b(Input.parse(TEST_INPUT)));
        Util.time(() -> b(Input.parse(INPUT)));
    }
}
