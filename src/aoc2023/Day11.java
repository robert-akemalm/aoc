package aoc2023;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.LongStream;

public class Day11 {
    private static void a(Input input) {
        List<Galaxy> expanded = expand(input.galaxies, 1);
        System.out.println(sumMinDistances(expanded));
    }

    private static void b(Input input) {
        List<Galaxy> expanded = expand(input.galaxies, 1_000_000 - 1);
        System.out.println(sumMinDistances(expanded));
    }

    private static long sumMinDistances(List<Galaxy> expanded) {
        long sum = 0;
        for (int i = 0; i < expanded.size(); i++) {
            for (int j = i + 1; j < expanded.size(); j++) {
                sum += expanded.get(i).distanceTo(expanded.get(j));
            }
        }
        return sum;
    }

    static List<Galaxy> expand(List<Galaxy> galaxies, int expansionRate) {
        Set<Long> xExpansions = expansionPoints(galaxies, Galaxy::x);
        Set<Long> yExpansions = expansionPoints(galaxies, Galaxy::y);
        return galaxies.stream()
                       .map(g -> new Galaxy(expand(g.y, yExpansions, expansionRate), expand(g.x, xExpansions, expansionRate)))
                       .toList();
    }

    static Set<Long> expansionPoints(List<Galaxy> galaxies, Function<Galaxy, Long> getCoordinate) {
        Set<Long> positions = galaxies.stream().mapToLong(getCoordinate::apply).boxed().collect(Collectors.toSet());
        long max = positions.stream().mapToLong(i -> i).max().orElseThrow();
        return LongStream.range(0, max).filter(x -> !positions.contains(x)).boxed().collect(Collectors.toSet());
    }

    static long expand(long coordinate, Set<Long> expansionPoints, int expansionRate) {
        return coordinate + LongStream.range(0, coordinate).filter(expansionPoints::contains).map(i -> expansionRate).sum();
    }

    record Galaxy(long y, long x) {
        public long distanceTo(Galaxy galaxy) {
            return Math.abs(galaxy.x - x) + Math.abs(galaxy.y - y);
        }
    }

    record Input(List<Galaxy> galaxies) {
        static Input parse(String input) {
            List<Galaxy> galaxies = new ArrayList<>();
            List<String> lines = input.lines().toList();
            for (int y = 0; y < lines.size(); y++) {
                String line = lines.get(y);
                for (int x = 0; x < line.length(); x++) {
                    if (line.charAt(x) == '#') {
                        galaxies.add(new Galaxy(y, x));
                    }
                }
            }
            return new Input(galaxies);
        }
    }

    private static final String TEST_INPUT = "...#......\n"
                                             + ".......#..\n"
                                             + "#.........\n"
                                             + "..........\n"
                                             + "......#...\n"
                                             + ".#........\n"
                                             + ".........#\n"
                                             + "..........\n"
                                             + ".......#..\n"
                                             + "#...#.....";

    private static final String INPUT =
            ".#......................#........................#.........................#................#...............................................\n"
            + "...........................................................................................................#...........#....................\n"
            + "........#...................#.......#............................................#....................#.................................#...\n"
            + ".........................................#............#.........................................#...........................................\n"
            + "....................................................................................................................................#.......\n"
            + "#...........................................................................................................................................\n"
            + "................#......................................................#.............#......................................................\n"
            + "......#..............#.........#......#........................#............................................................................\n"
            + "............#.....................................#......................................#...........................#......................\n"
            + ".....................................................................................................#....................#.................\n"
            + ".....................................................................#.......#............................#......#..............#...........\n"
            + "#...........................................................................................................................................\n"
            + "...................................#.....................................#..................................................................\n"
            + ".........#................#................................#...........................#......#.......................#..................#..\n"
            + "...............#....................................#..........................................................#............................\n"
            + "...........................................#..................................................................................#.............\n"
            + "...............................#...........................................#.......#.................#......................................\n"
            + "#..............................................................#..........................................#.................................\n"
            + "...........#.........................................................#.............................................#........................\n"
            + "......................#...........#...........................................#..........#.....#............................................\n"
            + "........................................................#...............................................................#......#............\n"
            + "...#..........#.........................#................................#..................................................................\n"
            + "............................................................................................................................................\n"
            + "..................#..................................#..............#..................................................................#....\n"
            + "...............................#...........................#...................#.............................#..............................\n"
            + "....................................#....................................................#.............#...............#...................#\n"
            + "................................................................................................#...........................................\n"
            + ".#............#............#........................................................#......................................#................\n"
            + ".......#...................................#........#.......................................................................................\n"
            + "..........................................................#.................................................................................\n"
            + "..............................................................................#..............#.......#................................#.....\n"
            + ".................................#..........................................................................#.........#.....................\n"
            + "....................#....................................................................#......................................#...........\n"
            + "........#...................................#.....................................................................#.........................\n"
            + "#........................#.........................#.............................................#..........................................\n"
            + ".................#.........................................#.........................#......................................................\n"
            + "..............................#.................................#.......................................................................#...\n"
            + "......#...............................#..............................................................................#.............#........\n"
            + "......................................................#..................#.................#............#.......#...........................\n"
            + "..............#...........#......................................................#..........................................................\n"
            + "............................................................#...............................................................................\n"
            + ".....................................................................#......................................................................\n"
            + ".#..................#........................................................................#................................#.............\n"
            + ".........................................#..........................................................................#.......................\n"
            + ".........#.....#..............#..............................................#.........#..............#..............................#.....#\n"
            + "...............................................................................................................#............................\n"
            + "...................................................#...................#...................................................#................\n"
            + ".......................#...........#..............................#......................................#..............................#...\n"
            + "...........#................#...............................................................................................................\n"
            + "...........................................................................#.................................#..............................\n"
            + "................#......................................................................#...........#........................................\n"
            + ".....................................................................................................................#........#......#......\n"
            + "..................................................#.............#..............................#............................................\n"
            + "......#.....#...........#..................#..............................................................#.................................\n"
            + "............................................................................................................................................\n"
            + "...................#...................#..................#....................................................#........................#...\n"
            + "............................................................................................................................................\n"
            + ".........................................................................#..................#...............................................\n"
            + ".....................................................................................................................................#.....#\n"
            + "...................................#...........#....................#.......................................................................\n"
            + "..#.....#.....................................................................#.........................#...................................\n"
            + "...........................#.........................#..................................#..........#..................#.....................\n"
            + "..................................................................................#............................................#............\n"
            + "..............#................#...............................#............................................................................\n"
            + "............................................................................................................................................\n"
            + ".....................................#.........#......................................#..............#........#..........#..................\n"
            + ".....#............#...............................................#........................................................................#\n"
            + "..........................................................................................................#.................................\n"
            + "..........#.............#.....#...........................#.....................#...........................................................\n"
            + "...............................................................#.................................#....................................#.....\n"
            + "....................................#..................................#....................................................................\n"
            + "#......................................................................................................#..........#..........#..............\n"
            + "..........................................#.............................................#...................................................\n"
            + ".................#.............................#........#......................................#.........................#...............#..\n"
            + "......................................#..........................................#..........................................................\n"
            + "............#...............................................#...............................................................................\n"
            + "...........................................................................................#..........................................#.....\n"
            + ".....#................#...............................................................................#.....................................\n"
            + "............................#......................#................#.............................................................#.........\n"
            + "...................................#.........................................................................................#..............\n"
            + ".#.......................................................................#.........#........................#...............................\n"
            + ".........................................#.................#.....................................#...............#..........................\n"
            + "..............................#.............................................................................................................\n"
            + ".................#...............................#.............................#.......#.....#.......#......................................\n"
            + ".......................................................................#....................................................................\n"
            + "............................................................................................................................................\n"
            + "......................................#...........................#.........................................................................\n"
            + ".................................................................................#..........................................................\n"
            + "..................................#.......................#.................................................................................\n"
            + "......................#..............................................#...........................#..........................#.....#.....#...\n"
            + "...........................#............#................................................................#.....#............................\n"
            + "...........................................................................................#................................................\n"
            + "............................................................................................................................................\n"
            + ".........#.........#..........................................................#.............................#.........#.............#.......\n"
            + "...........................................#.............#..................................................................................\n"
            + "............................#..........................................................#..........................#.........................\n"
            + ".......................#.........#..........................................................................................................\n"
            + "......#...........................................#....................#.......................#..........#.................................\n"
            + "...............#.................................................................#..........................................#...............\n"
            + "..........................................................#......#....................................................#............#......#.\n"
            + "......................................................................................................#.....................................\n"
            + "...............................................................................................................#............................\n"
            + "...............................#.....#................#.............................#.......................................................\n"
            + "..#............................................................................#...............#..........................#.................\n"
            + ".......#...................................#........................................................#.......................................\n"
            + "..............................................................#........#.....................................#..............................\n"
            + "...........................#.......#..............#......................................................................................#..\n"
            + "......................#......................................................................................................#......#.......\n"
            + "..............#...........................................................................................#.............#...................\n"
            + "..........................................................#.........#.........................#.............................................\n"
            + ".......................................#.......#...............................#..............................#.............................\n"
            + "................................#...................................................#.......................................................\n"
            + "#..........................................#........#..........#............................................................................\n"
            + "...........................................................................#............#.........................#..................#......\n"
            + "............#...........................................................................................#...................................\n"
            + "...................................#........................................................#...............................................\n"
            + "........................#.................................#......#.......................................................#..................\n"
            + "........#................................................................#..................................................................\n"
            + "...................#..............................#.................................#..............#.........#.....#.............#..........\n"
            + "..........................................#...................#........................................................................#....\n"
            + ".........................................................................................................#..................................\n"
            + "..............................#.........................................................#...................................................\n"
            + ".#..............#...........................................................................................................................\n"
            + "...................................#...........#........................................................................#...................\n"
            + ".........#...............................#........................................................................................#.........\n"
            + "....................#........................................................................#.....................#.........#............#.\n"
            + "..............................................................................#.......................#.......#.............................\n"
            + ".................................#.......................#...............#...............#..................................................\n"
            + "............................................................................................................................................\n"
            + "............................#........#......................................................................................................\n"
            + "......................#........................................#................#...........#..............#........................#.......\n"
            + ".....#.......#........................................................................#..........#........................................#.\n"
            + "..................................................#.........................................................................................\n"
            + "...............................................................................................................#.........#..................\n"
            + ".........................#........#........................#.............#..........................#.......................................\n"
            + "..........#..............................#......................#..........................#................................................\n"
            + "#..................................................................................#........................................................\n"
            + "...............................#................................................................................................#...........\n"
            + ".....................................................#.......#.............................................#................................\n"
            + "......#...............#..............#.........#..................#...............................................#......#...............#..";

    public static void main(String[] args) {
        Util.time(() -> a(Input.parse(TEST_INPUT)));
        Util.time(() -> a(Input.parse(INPUT)));
        Util.time(() -> b(Input.parse(TEST_INPUT)));
        Util.time(() -> b(Input.parse(INPUT)));
    }
}
