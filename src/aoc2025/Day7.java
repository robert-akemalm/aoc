package aoc2025;

import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import aoc2025.Util.Direction;
import aoc2025.Util.Pos;

public class Day7 {
    private static void a(Input input) {
        Set<Pos> beams = Set.of(input.start);
        int lastY = input.splitters.stream().mapToInt(Pos::y).max().orElseThrow();
        int numSplits = 0;
        for (int y = input.start.y(); y <= lastY; y++) {
            Set<Pos> nextBeams = new HashSet<>();
            for (Pos beam : beams) {
                Pos down = beam.next(Direction.DOWN);
                if (input.splitters.contains(down)) {
                    numSplits++;
                    nextBeams.add(down.next(Direction.LEFT));
                    nextBeams.add(down.next(Direction.RIGHT));
                } else {
                    nextBeams.add(down);
                }
            }
            beams = nextBeams;
        }
        System.out.println(numSplits);
    }

    private static void b(Input input) {
        System.out.println(timelines(input.start, input.splitters, input.splitters.stream().mapToInt(Pos::y).max()
                                                                                  .orElseThrow() + 1));
    }

    private static final Map<Pos, Long> NUM_TIMELINES = new HashMap<>();
    private static long timelines(Pos beam, Set<Pos> splitters, int maxY) {
        if (beam.y() == maxY) {
            return 1;
        }
        Pos down = beam.next(Direction.DOWN);
        if (NUM_TIMELINES.containsKey(down)) {
            return NUM_TIMELINES.get(down);
        }

        if (splitters.contains(down)) {
            long left = timelines(down.next(Direction.LEFT), splitters, maxY);
            long right = timelines(down.next(Direction.RIGHT), splitters, maxY);
            long timelines = left + right;
            NUM_TIMELINES.put(down, timelines);
            return timelines;
        } else {
            return timelines(down, splitters, maxY);
        }
    }

    record Input(Pos start, Set<Pos> splitters) {
        static Input parse(String input) {
            Pos start = null;
            Set<Pos> splitters = new HashSet<>();
            List<String> lines = input.lines().toList();
            for (int y = 0; y < lines.size(); y++) {
                for (int x = 0; x < lines.get(y).length(); x++) {
                    if (lines.get(y).charAt(x) == 'S') {
                        start = new Pos(x, y);
                    } else if (lines.get(y).charAt(x) == '^') {
                        splitters.add(new Pos(x, y));
                    }
                }
            }
            return new Input(start, splitters);
        }
    }

    private static final String TEST_INPUT = ".......S.......\n"
                                             + "...............\n"
                                             + ".......^.......\n"
                                             + "...............\n"
                                             + "......^.^......\n"
                                             + "...............\n"
                                             + ".....^.^.^.....\n"
                                             + "...............\n"
                                             + "....^.^...^....\n"
                                             + "...............\n"
                                             + "...^.^...^.^...\n"
                                             + "...............\n"
                                             + "..^...^.....^..\n"
                                             + "...............\n"
                                             + ".^.^.^.^.^...^.\n"
                                             + "...............";

    private static final String INPUT =
            "......................................................................S......................................................................\n"
            + ".............................................................................................................................................\n"
            + "......................................................................^......................................................................\n"
            + ".............................................................................................................................................\n"
            + ".....................................................................^.^.....................................................................\n"
            + ".............................................................................................................................................\n"
            + "....................................................................^...^....................................................................\n"
            + ".............................................................................................................................................\n"
            + "...................................................................^.^.^.^...................................................................\n"
            + ".............................................................................................................................................\n"
            + "..................................................................^.^...^.^..................................................................\n"
            + ".............................................................................................................................................\n"
            + ".................................................................^.^...^.^.^.................................................................\n"
            + ".............................................................................................................................................\n"
            + "................................................................^.^...^.^.^.^................................................................\n"
            + ".............................................................................................................................................\n"
            + "...............................................................^...^.^.^...^.^...............................................................\n"
            + ".............................................................................................................................................\n"
            + "..............................................................^...^.^.^...^.^.^..............................................................\n"
            + ".............................................................................................................................................\n"
            + ".............................................................^...^.....^.^...^.^.............................................................\n"
            + ".............................................................................................................................................\n"
            + "............................................................^.^.^.^...^.^.^.^...^............................................................\n"
            + ".............................................................................................................................................\n"
            + "...........................................................^.^.^.^.^.^.^...^.^.^.^...........................................................\n"
            + ".............................................................................................................................................\n"
            + "..........................................................^.^.^.^...^...^.^.^.^.^.^..........................................................\n"
            + ".............................................................................................................................................\n"
            + ".........................................................^.^.^.....^...^.^.^.^.^.^.^.........................................................\n"
            + ".............................................................................................................................................\n"
            + "........................................................^.^.^...^.^.^.^.^...^.^.^...^........................................................\n"
            + ".............................................................................................................................................\n"
            + ".......................................................^...^.^.^.^.....^.^...^.....^.^.......................................................\n"
            + ".............................................................................................................................................\n"
            + "......................................................^.^.^...^.^.^...^.^.^.^...^.^.^.^......................................................\n"
            + ".............................................................................................................................................\n"
            + ".....................................................^.^.^.^.^.^...^.^...^.^...^.^.^.^.^.....................................................\n"
            + ".............................................................................................................................................\n"
            + "....................................................^.^.^.^.^.^.^.^.....^.^.^...^...^...^....................................................\n"
            + ".............................................................................................................................................\n"
            + "...................................................^.^.^...^...^.....^.^...^.^.^.^.^...^.^...................................................\n"
            + ".............................................................................................................................................\n"
            + "..................................................^.....^.^.....^.....^.....^.^.^.^...^...^..................................................\n"
            + ".............................................................................................................................................\n"
            + ".................................................^...^.^.^...^.^.^.^.^.....^.^.^.^.....^...^.................................................\n"
            + ".............................................................................................................................................\n"
            + "................................................^.^.^.^.^.^.^.....^...^.....^.^.^...^.^...^.^................................................\n"
            + ".............................................................................................................................................\n"
            + "...............................................^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.............^.^...............................................\n"
            + ".............................................................................................................................................\n"
            + "..............................................^.^...^.^.......^.^.....^.^.^...^...^.^.^.....^.^..............................................\n"
            + ".............................................................................................................................................\n"
            + ".............................................^.^.^.^.^.^.^.^...^.^.^.^...^.....^.^.^.^...^...^.^.............................................\n"
            + ".............................................................................................................................................\n"
            + "............................................^.^.^.....^.....^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^.^............................................\n"
            + ".............................................................................................................................................\n"
            + "...........................................^...^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^...^.^.^.^...........................................\n"
            + ".............................................................................................................................................\n"
            + "..........................................^.^...^.^...^.^.^.^.^.^...^.....^.^.^...^.^...^.....^...^..........................................\n"
            + ".............................................................................................................................................\n"
            + ".........................................^...^.^.....^.^...^.....^.^.....^.^.^.....^.....^.^.^...^.^.........................................\n"
            + ".............................................................................................................................................\n"
            + "........................................^.^.^.^.^.^.^.^.^.^.....^.^.^.......^.^...^...^.^.^.^.^.^...^........................................\n"
            + ".............................................................................................................................................\n"
            + ".......................................^...^.......^.^...^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.....^.......................................\n"
            + ".............................................................................................................................................\n"
            + "......................................^.^.^.^...^.^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^...^......................................\n"
            + ".............................................................................................................................................\n"
            + ".....................................^.^.^.^.......^.^.^.^.^.^.^.^.....^.^.^.^.^.......^.^.....^...^.^.^.....................................\n"
            + ".............................................................................................................................................\n"
            + "....................................^.^.^.^.^.^.....^.^.^.^.^.^.....^.....^.^.^.^.^.^.^...^.^.....^.^...^....................................\n"
            + ".............................................................................................................................................\n"
            + "...................................^.^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.......^.^.^.^.^...^.^.........^...^...................................\n"
            + ".............................................................................................................................................\n"
            + "..................................^...............^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.........^..................................\n"
            + ".............................................................................................................................................\n"
            + ".................................^.^.^.^.^.^.^.^.....^...^.^.^.^.....^.^.^.^.^.^...^...^.........^.^.^.^.^.^.................................\n"
            + ".............................................................................................................................................\n"
            + "................................^.^...^...^.^...^.^.^...^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.....^.^.^.^.^...^................................\n"
            + ".............................................................................................................................................\n"
            + "...............................^.^.^.^.^.^.^...^.....^.^.^...^.^.^...^.^.^...^.^.....^...^.^.^...^.^.^.^.^...^...............................\n"
            + ".............................................................................................................................................\n"
            + "..............................^.^.^...^...^.^.^.^...^.^.^.^...^.^.^.^.^...^.^...^.^.^...^.^.^.^...^...^.^.^...^..............................\n"
            + ".............................................................................................................................................\n"
            + ".............................^...^.^.^...^.^...^.^.^.^.^.^.^.^.^.^...^...^.^...^.^...^.^.^.^...^...^.^...^.^.^.^.............................\n"
            + ".............................................................................................................................................\n"
            + "............................^...........^.^.^.^.^.^.^.^...^.^.^.^...^...^.^.^.^...^.^.......^.^.^.^.....^.^.^.^.^............................\n"
            + ".............................................................................................................................................\n"
            + "...........................^.^.^...^.....^.^...^.^...^.^.....^...^.^.^.^.^...^.^.^.^.....^.^.^.........^...^.^.^.^...........................\n"
            + ".............................................................................................................................................\n"
            + "..........................^.^.^.^.^...^.^...^.^...^.......^.^.^.^...^.^.^...^.^.^.....^...^.^.^.^...^.^.^.^.^.^.^.^..........................\n"
            + ".............................................................................................................................................\n"
            + ".........................^.^.^.^.^.^.^.^.^.^.^...^...^.^.^...^.^...^.......^...^...^.^.^.^.^...^.^.^.^.^.^...^.^...^.........................\n"
            + ".............................................................................................................................................\n"
            + "........................^.^.^...^.^...^.^.^...^.^...^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^.^........................\n"
            + ".............................................................................................................................................\n"
            + ".......................^.^.^...^...^.^.^.^.^.^.....^.....^.^.^.^.^.^.^.^.^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.......................\n"
            + ".............................................................................................................................................\n"
            + "......................^.^.^.^.....^.^.^...^.^.^.^...^...^.^.^...^...^.......^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.....^.^......................\n"
            + ".............................................................................................................................................\n"
            + ".....................^.....^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.....................\n"
            + ".............................................................................................................................................\n"
            + "....................^...^.^.^...^.^.....^.^...^.^.^.^.....^.^.^.^.^.....^.^.^.^.^.^.^.....^.....^.^.^.^.....^...^.^.^...^....................\n"
            + ".............................................................................................................................................\n"
            + "...................^.^.^.^...^.^.^.^.^.^.^.....^.^.....^...^.^.^.......^...^.^.^.^...^.^.^.^...^...^.^...^.^.^...^...^.^.^...................\n"
            + ".............................................................................................................................................\n"
            + "..................^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^.^.^...^.^.^.....^.^...^...^.^.^.^.^.^.^...^.^.^.......^.....^...^.^.^..................\n"
            + ".............................................................................................................................................\n"
            + ".................^...^.^...^.^.^.^.^...^.....^.^.^.....^...^.^.....^.^...^.^...^.^.^...^...^...^.^.^.^...^.^.....^.^...^.^.^.................\n"
            + ".............................................................................................................................................\n"
            + "................^.....^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.....^.^.^...^...^.^.^.^.^.^.^...^.......^.^.^...^.^.^...^.^.^...^...^.^................\n"
            + ".............................................................................................................................................\n"
            + "...............^.^.^...^...^.^.^...^.^.^.^...^.^.....^.^...^...^.......^...^.....^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^...^...^...............\n"
            + ".............................................................................................................................................\n"
            + "..............^...^...^...^.^.^.^.^.^.^.^...^...^...^.^.^.^.^.^.......^.^.....^.^.^.^.^.^.^.^.^.....^.^.^.^...^.^...^...^...^.^..............\n"
            + ".............................................................................................................................................\n"
            + ".............^.^.^.....^.....^.^...^.....^...^.^.^.^...^.^...^.^.^.^.^.^.....^.^.^.....^.^.....^.^.^.^...^...^.^.....^...^.^.^.^.............\n"
            + ".............................................................................................................................................\n"
            + "............^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^...^...^.^...^...^.^.^...^...^............\n"
            + ".............................................................................................................................................\n"
            + "...........^.^.^.......^.^...^.....^.^.^...^.^.^.^.^.^...^...^.....^.^.^.^.....^.^.^.^.^.....^.^.^.....^...^.^.^.^.^...^.^.^...^.^...........\n"
            + ".............................................................................................................................................\n"
            + "..........^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.^...^.^.^...^.^...^.^.^.^.^.^.^...^.^...^.^.^...^...^.^.^.^...^.^.^..........\n"
            + ".............................................................................................................................................\n"
            + ".........^...^.^.^...^.^.^.^.....^.^...^...^.^...^...^.^...^.^.....^.^.^...^.^...^.^.^.^...^.^.^.^.^.^...^.^.^...^.....^.^.^.^...^.^.........\n"
            + ".............................................................................................................................................\n"
            + "........^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^...^...^.^.^.^...........^.^.^...^.^.......^.^.^.....^........\n"
            + ".............................................................................................................................................\n"
            + ".......^.^.^.^.^.^.^.^...^.^.....^.......^.^.^.....^.^.^...^.^.^.^.^.^.^.....^...^.^.^.^.......^.^.....^.^.....^...^.^.^.^...^.^.^.^.^.......\n"
            + ".............................................................................................................................................\n"
            + "......^.....^...^.^...^.^...^.^.^.^.^.^.^.^...^.^.^...^...^.^...^.^.^.....^...^.......^.^.^...^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^......\n"
            + ".............................................................................................................................................\n"
            + ".....^.^.....^.^...^.^.^.^.^.^...^.....^...^.^...^.^...^...^.^.^.^.^.^.^.^.^...^.......^.^.^...^...^.^.....^.^.^.....^...^.^.^.^.......^.....\n"
            + ".............................................................................................................................................\n"
            + "....^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...^.^.^.....^.^...^.^.^.^...^.....^.^.^.^.^.^.^.^...^.^.^.^.^...^...^.^.^.......^.^.^.^.^...^.^.^.^....\n"
            + ".............................................................................................................................................\n"
            + "...^.^...^...^...^...^.^...^.^.^.^.^.^...^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^.^.^.........^...^...^.....^...^.^.^.^.^.^.....^.^...^.^.^...\n"
            + ".............................................................................................................................................\n"
            + "..^.^.......^.^.^.^.^.^.^.^...^.^.^.^...^.^.^...^.....^.^.....^.....^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^.^.^.^.......^...^.^...^.^.^.^..\n"
            + ".............................................................................................................................................\n"
            + ".^.........^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.^.....^...^.^.^.^.^...^...^.^.....^.......^.^...^.^...^.^...^.^.^...^.^.^.^...^.^.^...^.\n"
            + ".............................................................................................................................................";

    public static void main(String[] args) {
        Util.time(() -> a(Input.parse(TEST_INPUT)));
        Util.time(() -> a(Input.parse(INPUT)));
        Util.time(() -> b(Input.parse(TEST_INPUT)));
        Util.time(() -> b(Input.parse(INPUT)));
    }
}
